<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>An√°lise Estrat√©gica Estadual</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    font-family: 'Inter', 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#eef3f9,#f8fbff);
    margin:0;
    padding:40px;
    color:#1e2a38;
}

/* Container principal */
.container{
    max-width:1450px;
    margin:auto;
    background:rgba(255,255,255,0.85);
    backdrop-filter: blur(14px);
    padding:40px;
    border-radius:22px;
    box-shadow:
        0 30px 60px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.4);
    transition: all .4s ease;
}

h2{
    font-weight:600;
    letter-spacing:-0.5px;
    margin-bottom:25px;
}

.top-controls{
    display:flex;
    flex-wrap:wrap;
    gap:15px;
    margin-bottom:30px;
}

select,input{
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #e3e8ef;
    min-width:220px;
    background:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,0.04);
    transition:all .25s ease;
}

select:hover,input:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 18px rgba(0,0,0,0.08);
}

select:focus,input:focus{
    outline:none;
    border-color:#3a7bd5;
    box-shadow:0 0 0 3px rgba(58,123,213,0.15);
}

.card-candidato{
    display:none;
    align-items:center;
    gap:25px;
    margin:30px 0;
    padding:25px 30px;
    border-radius:18px;
    background:linear-gradient(135deg,#ffffff,#f5f9ff);
    box-shadow: 0 15px 35px rgba(0,0,0,0.06);
    animation: fadeSlide .4s ease;
}
 
.card-candidato img{
    width:130px;
    height:130px;
    border-radius:50%;
    object-fit:cover;
    border:5px solid white;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    transition:all .3s ease;
}

.card-candidato img:hover{
    transform:scale(1.05);
}

.total-votos{
    font-size:20px;
    color:#2b6ed4;
    font-weight:600;
    margin-top:6px;
}

table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 8px;
}

thead th{
    background:linear-gradient(90deg,#3a7bd5,#2b6ed4);
    color:white;
    padding:14px;
    text-align:left;
    font-weight:500;
    border:none;
}

tbody tr{
    background:white;
    box-shadow:0 6px 15px rgba(0,0,0,0.04);
    transition:all .25s ease;
}

tbody tr:hover{
    transform:translateY(-3px);
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
}

td{
    padding:14px;
    border:none;
}

button{
    padding:8px 14px;
    border:none;
    border-radius:10px;
    background:linear-gradient(135deg,#3a7bd5,#2b6ed4);
    color:white;
    font-weight:500;
    cursor:pointer;
    transition:all .25s ease;
    box-shadow:0 5px 15px rgba(58,123,213,0.3);
}

button:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(58,123,213,0.4);
}

/* --- ESTILOS DO MODAL E DASHBOARD --- */
.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.55);
    backdrop-filter:blur(6px);
    justify-content:center;
    align-items:center;
    animation: fade .3s ease;
    z-index: 1000;
}

.modal-content{
    background:white;
    padding:35px;
    border-radius:20px;
    width:95%;
    max-width:1200px;
    max-height:90vh;
    overflow:auto;
    box-shadow: 0 30px 60px rgba(0,0,0,0.25);
    animation: fadeSlide .4s ease;
}

.modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:25px;
}

.modal-header h3{
    font-size:22px;
    font-weight:600;
    color:#1e2a38;
    margin: 0;
}

.close-btn{
    background:#f1f4f9;
    border:none;
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
    font-size:16px;
    transition:.2s;
    color: #1e2a38;
}

.close-btn:hover{
    background:#e2e8f0;
    transform:scale(1.05);
}

.dashboard-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap:25px;
}

.card-dashboard{
    background:linear-gradient(135deg,#ffffff,#f7faff);
    padding:25px;
    border-radius:18px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    transition:.3s ease;
    border: 1px solid #f0f4f8;
}

.card-dashboard:hover{
    transform:translateY(-4px);
    box-shadow: 0 18px 35px rgba(0,0,0,0.08);
}

.card-dashboard h4{
    margin-bottom:15px;
    font-weight:600;
    font-size:15px;
    color:#2b6ed4;
    margin-top: 0;
}

@keyframes fadeSlide{
    from{opacity:0; transform:translateY(15px);}
    to{opacity:1; transform:translateY(0);}
}

@keyframes fade{
    from{opacity:0;}
    to{opacity:1;}
}
</style>
</head>
<body>

<div class="container">
    <h2>An√°lise Estrat√©gica Estadual</h2>

    <div class="top-controls">
        <select id="anoSelect">
            <option value="2022">2022</option>
            <option value="2018">2018</option>
            <option value="2014">2014</option>
            <option value="2010">2010</option>
        </select>

        <select id="cargoSelect">
            <option value="DEPUTADO ESTADUAL">DEPUTADO ESTADUAL</option>
            <option value="DEPUTADO FEDERAL">DEPUTADO FEDERAL</option>
        </select>

        <input type="text" id="buscarCandidato" placeholder="Buscar candidato">
        <select id="candidatoSelect"></select>

        <input type="text" id="buscarCidade" placeholder="Buscar cidade">
    </div>

    <div id="cardCandidato" class="card-candidato">
        <img id="fotoCandidato" alt="Foto do Candidato">
        <div>
            <h3 id="nomeCandidatoDisplay"></h3>
            <div class="total-votos" id="totalVotosCandidato"></div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Cidade</th>
                <th>Votos</th>
                <th>V√°lidos</th>
                <th>% Cidade</th>
                <th>Posi√ß√£o</th>
                <th>% RJ</th>
                <th>Perfil</th>
            </tr>
        </thead>
        <tbody id="resultado"></tbody>
    </table>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tituloCidade"></h3>
            <button class="close-btn" onclick="fecharModal()">‚úï</button>
        </div>

        <div class="dashboard-grid">
            <div class="card-dashboard">
                <h4>Distribui√ß√£o por G√™nero</h4>
                <canvas id="chartGenero"></canvas>
            </div>

            <div class="card-dashboard">
                <h4>Distribui√ß√£o por Faixa Et√°ria</h4>
                <canvas id="chartFaixa"></canvas>
            </div>

            <div class="card-dashboard">
                <h4>Estado Civil</h4>
                <canvas id="chartEstadoCivil"></canvas>
            </div>

            <div class="card-dashboard">
                <h4>Escolaridade</h4>
                <canvas id="chartEscolaridade"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let resumo = {};
let eleitorado = {};
let candidatoSelecionado = null;
let sqSelecionado = null;
let charts = [];

window.onload = async function() {
    await carregarAno();
};

document.getElementById("anoSelect").addEventListener("change", carregarAno);
document.getElementById("cargoSelect").addEventListener("change", preencherCandidatos);
document.getElementById("buscarCandidato").addEventListener("input", preencherCandidatos);
document.getElementById("buscarCidade").addEventListener("input", mostrarAnalise);

function normalizarTexto(txt) {
    if (!txt) return "";
    return txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
}

let cidadesDisponiveis = [];
let cacheCidades = {};
resumo = {}; // mant√©m vari√°vel global para compatibilidade

async function carregarAno() {

    let ano = document.getElementById("anoSelect").value;

    cidadesDisponiveis = [];
    cacheCidades = {};
    resumo = {};

    try {
        // üîπ Carrega lista de cidades
        const resIndex = await fetch(`dados_processados/${ano}/index.json`);
        const dataIndex = await resIndex.json();

        cidadesDisponiveis = dataIndex.cidades;

    } catch (e) {
        console.error("Erro ao carregar index:", e);
        return;
    }

    try {
        // üîπ Eleitorado continua sendo √∫nico
        const resEleitorado = await fetch(`dados_processados/${ano}/eleitorado.json`);
        eleitorado = await resEleitorado.json();
    } catch (e) {
        console.warn("Eleitorado n√£o encontrado para", ano);
        eleitorado = {};
    }

    preencherCandidatos();
}

async function carregarCidade(nomeCidade) {

    if (cacheCidades[nomeCidade]) {
        return cacheCidades[nomeCidade];
    }

    let ano = document.getElementById("anoSelect").value;

    const response = await fetch(`dados_processados/${ano}/${nomeCidade}.json`);
    const dados = await response.json();

    cacheCidades[nomeCidade] = dados;

    return dados;
}



async function preencherCandidatos() {

    let cargoSelecionado = document.getElementById("cargoSelect").value;
    let filtro = normalizarTexto(document.getElementById("buscarCandidato").value);
    let select = document.getElementById("candidatoSelect");
    select.innerHTML = "";

    let mapa = {};

    for (let cidade of cidadesDisponiveis) {

        let dadosCidadeArquivo = await carregarCidade(cidade);

        let chaveCargo = Object.keys(dadosCidadeArquivo)
            .find(k => k.toUpperCase() === cargoSelecionado.toUpperCase());

        if (!chaveCargo) continue;

        let nomeCidade = Object.keys(dadosCidadeArquivo[chaveCargo].CIDADES)[0];

        let candidatos = dadosCidadeArquivo[chaveCargo]
            .CIDADES[nomeCidade].candidatos;

        candidatos.forEach(c => {
            if (c.nome && !c.nome.includes("NULO") && !c.nome.includes("BRANCO")) {
                mapa[c.nome] = c.sq_candidato;
            }
        });
    }

    let nomesFiltrados = Object.keys(mapa)
        .sort()
        .filter(nome => normalizarTexto(nome).includes(filtro));

    nomesFiltrados.forEach(nome => {
        let option = document.createElement("option");
        option.value = nome;
        option.text = nome;
        option.dataset.sq = mapa[nome];
        select.appendChild(option);
    });

    select.onchange = function () {
        if (this.selectedIndex === -1) return;
        candidatoSelecionado = this.value;
        sqSelecionado = this.options[this.selectedIndex].dataset.sq;
        document.getElementById("nomeCandidatoDisplay").innerText = candidatoSelecionado;
        atualizarFoto();
        mostrarAnalise();
    };

    if (nomesFiltrados.length > 0) select.onchange();
}


function atualizarFoto() {
    if (!sqSelecionado) return;

    let ano = document.getElementById("anoSelect").value;
    let prefixo = (ano == "2010" || ano == "2014") ? "RJ" : "FRJ";
    let fotoUrl = `fotos/${ano}/RJ/${prefixo}${sqSelecionado}_div.jpg`;

    let img = document.getElementById("fotoCandidato");

    img.onerror = null; 
    img.src = fotoUrl;

    img.onerror = function() {
        this.onerror = null;
        this.src = "sem-foto.png";
    };

    document.getElementById("cardCandidato").style.display = "flex";
}


async function mostrarAnalise() {

    if (!candidatoSelecionado) return;

    let cargoSelecionado = document.getElementById("cargoSelect").value;
    let filtroCidade = normalizarTexto(document.getElementById("buscarCidade").value);
    let tbody = document.getElementById("resultado");
    tbody.innerHTML = "";

    let totalVotosGeral = 0;
    let totalRJ = 0;

    for (let cidade of cidadesDisponiveis) {

        let dadosCidadeArquivo = await carregarCidade(cidade);

        let chaveCargo = Object.keys(dadosCidadeArquivo)
            .find(k => k.toUpperCase() === cargoSelecionado.toUpperCase());

        if (!chaveCargo) continue;

        totalRJ = dadosCidadeArquivo[chaveCargo].TOTAL_RJ;

        let nomeCidade = Object.keys(dadosCidadeArquivo[chaveCargo].CIDADES)[0];

        if (filtroCidade && !normalizarTexto(nomeCidade).includes(filtroCidade)) continue;

        let dadosCidade = dadosCidadeArquivo[chaveCargo].CIDADES[nomeCidade];

        let candidato = dadosCidade.candidatos.find(c =>
            normalizarTexto(c.nome) === normalizarTexto(candidatoSelecionado)
        );

        if (!candidato) continue;

        totalVotosGeral += candidato.votos;

        let percentualCidade = ((candidato.votos / dadosCidade.total_validos) * 100).toFixed(2);
        let percentualRJ = ((candidato.votos / totalRJ) * 100).toFixed(4);

        let tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${nomeCidade}</td>
            <td>${candidato.votos.toLocaleString()}</td>
            <td>${dadosCidade.total_validos.toLocaleString()}</td>
            <td>${percentualCidade}%</td>
            <td>${candidato.posicao}¬∫</td>
            <td>${percentualRJ}%</td>
            <td><button onclick="abrirModal('${nomeCidade}')">Perfil</button></td>
        `;

        tbody.appendChild(tr);
    }

    document.getElementById("totalVotosCandidato").innerText =
        "Total no Estado: " + totalVotosGeral.toLocaleString() + " votos";
}

async function abrirBairros(cidadeNome) {

    let ano = document.getElementById("anoSelect").value;
    let cargoSelecionado = document.getElementById("cargoSelect").value;

    try {
        const resBairro = await fetch(`dados_processados/resumo_bairro_${ano}.json`);
        const resumoBairro = await resBairro.json();

        let chaveCargo = Object.keys(resumoBairro)
            .find(k => k.toUpperCase() === cargoSelecionado.toUpperCase());

        if (!chaveCargo) return;

        let dadosCidade = resumoBairro[chaveCargo].CIDADES[cidadeNome];

        if (!dadosCidade || !dadosCidade.BAIRROS) {
            alert("Sem detalhamento por bairro.");
            return;
        }

        let container = document.querySelector(".dashboard-grid");
        container.innerHTML = "";

        Object.keys(dadosCidade.BAIRROS).forEach(bairroNome => {

            let dadosBairro = dadosCidade.BAIRROS[bairroNome];

            let candidato = dadosBairro.candidatos.find(c =>
                normalizarTexto(c.nome) === normalizarTexto(candidatoSelecionado)
            );

            if (!candidato) return;

            let percentual = (
                (candidato.votos / dadosBairro.total_validos) * 100
            ).toFixed(2);

            let div = document.createElement("div");
            div.className = "card-dashboard";
            div.innerHTML = `
                <h4>${bairroNome}</h4>
                <p><strong>Votos:</strong> ${candidato.votos.toLocaleString()}</p>
                <p><strong>V√°lidos:</strong> ${dadosBairro.total_validos.toLocaleString()}</p>
                <p><strong>% Bairro:</strong> ${percentual}%</p>
                <p><strong>Posi√ß√£o:</strong> ${candidato.posicao}¬∫</p>
            `;
            container.appendChild(div);
        });

        document.getElementById("tituloCidade").innerText =
            "Detalhamento por Bairro - " + cidadeNome;

        document.getElementById("modal").style.display = "flex";

    } catch (e) {
        console.error("Erro ao carregar bairros:", e);
    }
}


function abrirModal(cidade){
    document.getElementById("tituloCidade").innerText = "Perfil do Eleitorado - " + cidade;
    destruirGraficos();
    let dados = eleitorado[cidade];
    if(!dados) {
        alert("Dados de perfil n√£o dispon√≠veis para esta cidade.");
        return;
    }
    criarGrafico("chartGenero", "Distribui√ß√£o por G√™nero", dados.genero);
    criarGrafico("chartFaixa", "Faixa Et√°ria", dados.faixa_etaria);
    criarGrafico("chartEstadoCivil", "Estado Civil", dados.estado_civil);
    criarGrafico("chartEscolaridade", "Escolaridade", dados.escolaridade);
    document.getElementById("modal").style.display = "flex";
}

function fecharModal(){
    document.getElementById("modal").style.display = "none";
}

function criarGrafico(id, titulo, dadosObj) {
    let ctx = document.getElementById(id);
    let chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(dadosObj),
            datasets: [{
                data: Object.values(dadosObj),
                backgroundColor: '#3a7bd5',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { grid: { display: false } },
                y: { 
                    beginAtZero: true,
                    grid: { color: "rgba(0,0,0,0.05)" }
                }
            }
        }
    });
    charts.push(chart);
}

function destruirGraficos(){
    charts.forEach(c => c.destroy());
    charts = [];
}
</script>


</body>
</html>